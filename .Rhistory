indices <- indices[!is.na(indices) & indices > 0]
# Apply formatting to each specified column
for (col in indices) {
# Adjust column index (now accounts for renamed columns)
display_col <- col + 3  # Adjust based on your column structure
if (display_col <= ncol(bacscout_df_merge)) {
# Get original value
original_value <- bacscout_df_merge[i, display_col]  # Adjust offset as needed
# Apply LaTeX formatting for PDF
bacscout_df_merge[i, display_col] <- paste0("\\textcolor{blue}{\\textbf{",
as.character(original_value), "}}")
}
}
}
}
# --- Generate formatted table ---
bacscout_df_merge %>%
kable(booktabs = TRUE, align = "c", escape = FALSE, row.names = FALSE) %>%
column_spec(1, width = "1cm") %>%
column_spec(2, width = "2.5cm") %>%
column_spec(3, width = "4cm", italic = TRUE) %>%
column_spec(4:11, width = "1.5cm") %>%
row_spec(0, background = "#D4D4D4", bold = TRUE, align = "c")
# --- Modify and Filter Bactscout dataframe ---
df_bactscout_mod <- df_bactscout %>%
mutate(name = gsub("-", "_", name)) %>%
filter(name %in% sample_name)
# --- Create new column to check final status with warning status and list column indices with failed results ---
df_bactscout_result <- df_bactscout_mod %>%
select(name, species, a_final_status, contamination_message, coverage_status, coverage_estimate_qualibact_status, duplication_status,
gc_content_status,	mlst_status,	read_length_status,	read_q30_status)
df_bactscout_result$failed_idx_if_warning <- apply(df_bactscout_result, 1, function(row) {
if (row["a_final_status"] == "WARNING") {
# Get indices of columns with FAILED
failed_cols <- which(row[-c(1:3 )] == "FAILED") # exclude sample_id & a_final_status
# Adjust index to match original dataframe
failed_cols <- failed_cols + 3
paste(failed_cols, collapse = ", ")
} else {
""
}
})
# --- List sample without bactscout result ---
no_bactscout_result <- setdiff(sample_name, df_bactscout_mod$name)
# --- remove text after last underscore ---
no_bactscout_result <- sub("_[^_]*$", "", no_bactscout_result)
# --- Modify dataframe ---
bacscout_df_value <- df_bactscout_mod %>%
select(name, species, species_abundance, coverage_estimate_sylph, coverage_estimate_qualibact, duplication_rate,
gc_content, mlst_st, read1_mean_length, read2_mean_length, read_q30_rate) %>%
rename(sample_id = name) %>%
mutate(read_length = paste0(read1_mean_length, " - ", read2_mean_length)) %>%
select(-read1_mean_length, -read2_mean_length) %>%
relocate(read_length, .before = "read_q30_rate")
# --- Get Isolate number by merging ---
bacscout_df_merge <- merge(bacscout_df_value, arsrl_id_df, by ="sample_id")
# --- Modify dataframe ---
bacscout_df_merge <- bacscout_df_merge %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id)) %>%
select(-arsrl_org) %>%
relocate(iso_num, .before = "sample_id")
# Rename and reorder columns
colnames(bacscout_df_merge) <- c("Isolate No.","Sample ID", "Species", "Species Abundance", "Coverage (Sylph)", "Coverage (Qualibact)", "Duplication Rate",
"GC Content", "MLST (ST)", "Read Length", "Read Q30")
for (i in 1:nrow(df_bactscout_result)) {
if (!is.na(df_bactscout_result$failed_idx_if_warning[i]) && nzchar(df_bactscout_result$failed_idx_if_warning[i])) {
# Split and convert to numeric safely
indices <- tryCatch({
as.numeric(trimws(unlist(strsplit(df_bactscout_result$failed_idx_if_warning[i], ","))))
}, error = function(e) numeric(0))
# Remove any NAs from conversion
indices <- indices[!is.na(indices) & indices > 0]
# Apply formatting to each specified column
for (col in indices) {
# Adjust column index (now accounts for renamed columns)
display_col <- col
#display_col <- col + 3  # Adjust based on your column structure
if (display_col <= ncol(bacscout_df_merge)) {
# Get original value
original_value <- bacscout_df_merge[i, display_col]  # Adjust offset as needed
# Apply LaTeX formatting for PDF
bacscout_df_merge[i, display_col] <- paste0("\\textcolor{blue}{\\textbf{",
as.character(original_value), "}}")
}
}
}
}
# --- Generate formatted table ---
bacscout_df_merge %>%
kable(booktabs = TRUE, align = "c", escape = FALSE, row.names = FALSE) %>%
column_spec(1, width = "1cm") %>%
column_spec(2, width = "2.5cm") %>%
column_spec(3, width = "4cm", italic = TRUE) %>%
column_spec(4:11, width = "1.5cm") %>%
row_spec(0, background = "#D4D4D4", bold = TRUE, align = "c")
if(nrow(wgs_df) != 0){
rmarkdown::render("wgs_qc_report_ver2.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.pdf', sep='')
)
}else{
cat("No file found")
}
# --- Modify and Filter Bactscout dataframe ---
df_bactscout_mod <- df_bactscout %>%
mutate(name = gsub("-", "_", name)) %>%
filter(name %in% sample_name)
# --- Create new column to check final status with warning status and list column indices with failed results ---
df_bactscout_result <- df_bactscout_mod %>%
select(name, species, a_final_status, contamination_message, coverage_status, coverage_estimate_qualibact_status, duplication_status,
gc_content_status,	mlst_status,	read_length_status,	read_q30_status)
df_bactscout_result$failed_idx_if_warning <- apply(df_bactscout_result, 1, function(row) {
if (row["a_final_status"] == "WARNING") {
# Get indices of columns with FAILED
failed_cols <- which(row[-c(1:3 )] == "FAILED") # exclude sample_id & a_final_status
# Adjust index to match original dataframe
failed_cols <- failed_cols + 3
paste(failed_cols, collapse = ", ")
} else {
""
}
})
# set color for failed result
failure_color <- which(df_bactscout_result$a_final_status == 'FAILED')
# --- List sample without bactscout result ---
no_bactscout_result <- setdiff(sample_name, df_bactscout_mod$name)
# --- remove text after last underscore ---
no_bactscout_result <- sub("_[^_]*$", "", no_bactscout_result)
# --- Modify dataframe ---
bacscout_df_value <- df_bactscout_mod %>%
select(name, species, species_abundance, coverage_estimate_sylph, coverage_estimate_qualibact, duplication_rate,
gc_content, mlst_st, read1_mean_length, read2_mean_length, read_q30_rate) %>%
rename(sample_id = name) %>%
mutate(read_length = paste0(read1_mean_length, " - ", read2_mean_length)) %>%
select(-read1_mean_length, -read2_mean_length) %>%
relocate(read_length, .before = "read_q30_rate")
# --- Get Isolate number by merging ---
bacscout_df_merge <- merge(bacscout_df_value, arsrl_id_df, by ="sample_id")
# --- Modify dataframe ---
bacscout_df_merge <- bacscout_df_merge %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id)) %>%
select(-arsrl_org) %>%
relocate(iso_num, .before = "sample_id")
# Rename and reorder columns
colnames(bacscout_df_merge) <- c("Isolate No.","Sample ID", "Species", "Species Abundance", "Coverage (Sylph)", "Coverage (Qualibact)", "Duplication Rate",
"GC Content", "MLST (ST)", "Read Length", "Read Q30")
for (i in 1:nrow(df_bactscout_result)) {
if (!is.na(df_bactscout_result$failed_idx_if_warning[i]) && nzchar(df_bactscout_result$failed_idx_if_warning[i])) {
# Split and convert to numeric safely
indices <- tryCatch({
as.numeric(trimws(unlist(strsplit(df_bactscout_result$failed_idx_if_warning[i], ","))))
}, error = function(e) numeric(0))
# Remove any NAs from conversion
indices <- indices[!is.na(indices) & indices > 0]
# Apply formatting to each specified column
for (col in indices) {
# Adjust column index (now accounts for renamed columns)
display_col <- col
#display_col <- col + 3  # Adjust based on your column structure
if (display_col <= ncol(bacscout_df_merge)) {
# Get original value
original_value <- bacscout_df_merge[i, display_col]  # Adjust offset as needed
# Apply LaTeX formatting for PDF
bacscout_df_merge[i, display_col] <- paste0("\\textcolor{blue}{\\textbf{",
as.character(original_value), "}}")
}
}
}
}
# --- Generate formatted table ---
# Create the table
bacscout_df_merge %>%
kable(format = "latex", booktabs = TRUE, escape = FALSE, align = "c", row.names = FALSE) %>%
kable_styling(latex_options = c("scale_down", "hold_position")) %>%
row_spec(failure_color, background = "#FD7979") %>%
row_spec(0, background = "#D4D4D4",bold = TRUE) %>%
column_spec(3,italic = TRUE) %>%
footnote(general = c("PASS","  |  ",
"\\\\colorbox{Salmon}{FAILURE}","  |  ",
"\\\\textcolor{Blue}{EXCEEDS THRESHOLD METRIC/S}","  |  ",
"(x) - NON-CONCORDANT","  |"),
general_title = "Legend:",
footnote_as_chunk = T, escape = F)
if(nrow(wgs_df) != 0){
rmarkdown::render("wgs_qc_report_ver2.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.pdf', sep='')
)
}else{
cat("No file found")
}
View(bacscout_df_merge)
bacscout_df_merge <- bacscout_df_merge %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id)) %>%
select(-arsrl_org) %>%
relocate(iso_num, .before = "sample_id")
if(nrow(wgs_df) != 0){
rmarkdown::render("wgs_qc_report_ver2.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.pdf', sep='')
)
}else{
cat("No file found")
}
# --- Modify and Filter Bactscout dataframe ---
df_bactscout_mod <- df_bactscout %>%
mutate(name = gsub("-", "_", name)) %>%
filter(name %in% sample_name)
# --- Create new column to check final status with warning status and list column indices with failed results ---
df_bactscout_result <- df_bactscout_mod %>%
select(name, species, a_final_status, contamination_message, coverage_status, coverage_estimate_qualibact_status, duplication_status,
gc_content_status,	mlst_status,	read_length_status,	read_q30_status)
df_bactscout_result$failed_idx_if_warning <- apply(df_bactscout_result, 1, function(row) {
if (row["a_final_status"] == "WARNING") {
# Get indices of columns with FAILED
failed_cols <- which(row[-c(1:3 )] == "FAILED") # exclude sample_id & a_final_status
# Adjust index to match original dataframe
failed_cols <- failed_cols + 3
paste(failed_cols, collapse = ", ")
} else {
""
}
})
df_bactscout_result$failed_cols_if_warning <- apply(df_bactscout_result, 1, function(row) {
if (row["a_final_status"] == "WARNING") {
warning_cols <- names(row)[which(row[-c(1,2)] == "WARNING") + 2] # adjust for original df
if (length(warning_cols) == 0) {
""
} else {
paste(warning_cols, collapse = ", ")
}
} else {
""
}
})
# set color for failed result
failure_color <- which(df_bactscout_result$a_final_status == 'FAILED')
# --- List sample without bactscout result ---
no_bactscout_result <- setdiff(sample_name, df_bactscout_mod$name)
# --- remove text after last underscore ---
no_bactscout_result <- sub("_[^_]*$", "", no_bactscout_result)
# --- Modify dataframe ---
bacscout_df_value <- df_bactscout_mod %>%
select(name, species, species_abundance, coverage_estimate_sylph, coverage_estimate_qualibact, duplication_rate,
gc_content, mlst_st, read1_mean_length, read2_mean_length, read_q30_rate) %>%
rename(sample_id = name) %>%
mutate(read_length = paste0(read1_mean_length, " - ", read2_mean_length)) %>%
select(-read1_mean_length, -read2_mean_length) %>%
relocate(read_length, .before = "read_q30_rate")
# --- Get Isolate number by merging ---
bacscout_df_merge <- merge(bacscout_df_value, arsrl_id_df, by ="sample_id")
# --- Modify dataframe ---
bacscout_df_merge <- bacscout_df_merge %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id)) %>%
select(-arsrl_org) %>%
relocate(iso_num, .before = "sample_id")
bacscout_df_merge$sample_id <- gsub("_", "\\_", bacscout_df_merge$sample_id, fixed = TRUE)
# Rename and reorder columns
colnames(bacscout_df_merge) <- c("Isolate No.","Sample ID", "Species", "Species Abundance", "Coverage (Sylph)", "Coverage (Qualibact)", "Duplication Rate",
"GC Content", "MLST (ST)", "Read Length", "Read Q30")
for (i in 1:nrow(df_bactscout_result)) {
if (!is.na(df_bactscout_result$failed_idx_if_warning[i]) && nzchar(df_bactscout_result$failed_idx_if_warning[i])) {
# Split and convert to numeric safely
indices <- tryCatch({
as.numeric(trimws(unlist(strsplit(df_bactscout_result$failed_idx_if_warning[i], ","))))
}, error = function(e) numeric(0))
# Remove any NAs from conversion
indices <- indices[!is.na(indices) & indices > 0]
# Apply formatting to each specified column
for (col in indices) {
# Adjust column index (now accounts for renamed columns)
display_col <- col
#display_col <- col + 3  # Adjust based on your column structure
if (display_col <= ncol(bacscout_df_merge)) {
# Get original value
original_value <- bacscout_df_merge[i, display_col]  # Adjust offset as needed
# Apply LaTeX formatting for PDF
bacscout_df_merge[i, display_col] <- paste0("\\textcolor{blue}{\\textbf{",
as.character(original_value), "}}")
}
}
}
}
# --- Generate formatted table ---
# Create the table
bacscout_df_merge %>%
kable(format = "latex", booktabs = TRUE, escape = FALSE, align = "c", row.names = FALSE) %>%
kable_styling(latex_options = c("scale_down", "hold_position")) %>%
row_spec(failure_color, background = "#FD7979") %>%
row_spec(0, background = "#D4D4D4",bold = TRUE) %>%
column_spec(3,italic = TRUE) %>%
footnote(general = c("PASS","  |  ",
"\\\\colorbox{Salmon}{FAILURE}","  |  ",
"\\\\textcolor{Blue}{EXCEEDS THRESHOLD METRIC/S}","  |  ",
"(x) - NON-CONCORDANT","  |"),
general_title = "Legend:",
footnote_as_chunk = T, escape = F)
View(df_bactscout_result)
df_bactscout_result$failed_cols_if_warning <- apply(df_bactscout_result, 1, function(row) {
if (row["a_final_status"] == "WARNING") {
warning_cols <- names(row)[which(row[-c(1,2)] == "FAILED") + 2] # adjust for original df
if (length(warning_cols) == 0) {
""
} else {
paste(warning_cols, collapse = ", ")
}
} else {
""
}
})
View(df_bactscout_result)
# --- Modify and Filter Bactscout dataframe ---
df_bactscout_mod <- df_bactscout %>%
mutate(name = gsub("-", "_", name)) %>%
filter(name %in% sample_name)
# --- Create new column to check final status with warning status and list column indices with failed results ---
df_bactscout_result <- df_bactscout_mod %>%
select(name, species, a_final_status, contamination_message = contamination, coverage_status = `Coverage (Sylph)`,
coverage_estimate_qualibact_status = `Coverage (Qualibact)`, duplication_status = `Duplication Rate`,
gc_content_status = `GC Content`,	mlst_status = `MLST (ST)`,	read_length_status = `Read Length`,	read_q30_status = `Read Q30`)
# --- Create new column to check final status with warning status and list column indices with failed results ---
df_bactscout_result <- df_bactscout_mod %>%
select(name, species, a_final_status, contamination = contamination_message, `Coverage (Sylph)` = coverage_status,
`Coverage (Qualibact)` = coverage_estimate_qualibact_status, `Duplication Rate` = duplication_status,
`GC Content` = gc_content_status, `MLST (ST)` = mlst_status, `Read Length` = read_length_status, `Read Q30` = read_q30_status)
View(df_bactscout_result)
df_bactscout_result$failed_idx_if_warning <- apply(df_bactscout_result, 1, function(row) {
if (row["a_final_status"] == "WARNING") {
# Get indices of columns with FAILED
failed_cols <- which(row[-c(1:3 )] == "FAILED") # exclude sample_id & a_final_status
# Adjust index to match original dataframe
failed_cols <- failed_cols + 3
paste(failed_cols, collapse = ", ")
} else {
""
}
})
df_bactscout_result$failed_cols_if_warning <- apply(df_bactscout_result, 1, function(row) {
if (row["a_final_status"] == "WARNING") {
warning_cols <- names(row)[which(row[-c(1,2)] == "FAILED") + 2] # adjust for original df
if (length(warning_cols) == 0) {
""
} else {
paste(warning_cols, collapse = ", ")
}
} else {
""
}
})
View(df_bactscout_result)
View(qc_listing_df)
View(wgs_id_df)
View(wgs_df)
non_concordant <- wgs_df %>%filter(concordant == "FALSE")
View(df_bactscout_mod)
View(df_bactscout_result)
failed_raw_reads <- df_bactscout_result %>% filter(failed_cols_if_warning != "")
View(failed_raw_reads)
non_concordant <- wgs_df %>% filter(concordant == "FALSE") %>%
select(sample_id, concordant)
failed_raw_reads <- df_bactscout_result %>% filter(failed_cols_if_warning != "") %>%
select(sample_id, failed_cols_if_warning)
failed_raw_reads <- df_bactscout_result %>% filter(failed_cols_if_warning != "") %>%
select(name, failed_cols_if_warning)
View(failed_raw_reads)
non_concordant <- wgs_df %>% filter(concordant == "FALSE") %>%
select(sample_id, failed_conditions = concordant)
failed_raw_reads <- df_bactscout_result %>% filter(failed_cols_if_warning != "") %>%
select(name, failed_conditions = failed_cols_if_warning)
View(wgs_lowreads)
View(non_concordant)
View(wgs_df)
View(df_bactscout_result)
if (nrow(wgs_lowreads) != 0){
wgs_lowreads_reco <- wgs_lowreads %>%
mutate(
failed_conditions = "Low read counts",
remarks = "For repeat testing"
) %>%
select(-description)
}
failed_raw_reads <- df_bactscout_result %>% filter(failed_cols_if_warning != "") %>%
select(name, failed_conditions = failed_cols_if_warning) %>%
rename(sample_id = name)
View(failed_raw_reads)
reco_df <- do.call("rbind", list(non_concordant, failed_raw_reads, wgs_lowreads))
View(reco_df)
View(reco_df)
non_concordant <- wgs_df %>% filter(concordant == "FALSE") %>%
select(sample_id, failed_conditions = concordant) %>%
mutate(remarks = "For repeat testing")
failed_raw_reads <- df_bactscout_result %>% filter(failed_cols_if_warning != "") %>%
select(name, failed_conditions = failed_cols_if_warning) %>%
rename(sample_id = name) %>%
mutate(remarks = "For repeat testing")
if (nrow(wgs_lowreads) != 0){
wgs_lowreads_reco <- wgs_lowreads %>%
mutate(
failed_conditions = "Low read counts",
remarks = "For repeat testing"
) %>%
select(-description)
}
View(failed_raw_reads)
# --- bind multiple dataframe ---
reco_df <- do.call("rbind", list(non_concordant, failed_raw_reads, wgs_lowreads))
View(reco_df)
non_concordant <- wgs_df %>% filter(concordant == "FALSE") %>%
select(sample_id, failed_conditions = concordant)
failed_raw_reads <- df_bactscout_result %>% filter(failed_cols_if_warning != "") %>%
select(name, failed_conditions = failed_cols_if_warning) %>%
rename(sample_id = name)
if (nrow(wgs_lowreads) != 0){
wgs_lowreads_reco <- wgs_lowreads %>%
mutate(failed_conditions = "Low read counts") %>%
select(-description)
}
# --- bind multiple dataframe ---
reco_df <- do.call("rbind", list(non_concordant, failed_raw_reads, wgs_lowreads))
reco_df <- bind_rows(
# Non-concordant WGS
wgs_df %>%
filter(concordant == "FALSE") %>%
transmute(sample_id, failed_conditions = "Non-concordant result"),
# Failed raw reads (from BactScout)
df_bactscout_result %>%
filter(failed_cols_if_warning != "") %>%
transmute(sample_id = name,
failed_conditions = failed_cols_if_warning),
# Low read counts (only if exists)
if (nrow(wgs_lowreads) > 0)
wgs_lowreads %>%
transmute(sample_id,
failed_conditions = "Low read counts")
) %>%
group_by(sample_id) %>%
summarise(
failed_conditions = paste(unique(failed_conditions), collapse = ", "),
.groups = "drop"
)%>%
mutate(remarks = "For repeat testing")
View(reco_df)
reco_df <- bind_rows(
# Non-concordant WGS
wgs_df %>%
filter(concordant == "FALSE") %>%
transmute(sample_id, failed_conditions = "Non-concordant result"),
# Failed raw reads (from BactScout)
df_bactscout_result %>%
filter(failed_cols_if_warning != "") %>%
transmute(sample_id = name,
failed_conditions = failed_cols_if_warning),
# Low read counts (only if exists)
if (nrow(wgs_lowreads) > 0)
wgs_lowreads %>%
transmute(sample_id,
failed_conditions = "Low read counts")
) %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id)) %>%   # ðŸ‘ˆ normalize IDs
group_by(sample_id) %>%
summarise(
failed_conditions = paste(unique(failed_conditions), collapse = ", "),
.groups = "drop"
) %>%
mutate(remarks = "For repeat testing")
View(reco_df)
View(reco_df)
reco_df <- bind_rows(
# Non-concordant WGS
wgs_df %>%
filter(concordant == "FALSE") %>%
transmute(sample_id, failed_conditions = "Non-concordant result"),
# Failed raw reads (from BactScout)
df_bactscout_result %>%
filter(failed_cols_if_warning != "") %>%
transmute(sample_id = name,
failed_conditions = failed_cols_if_warning),
# Low read counts (only if exists)
if (nrow(wgs_lowreads) > 0)
wgs_lowreads %>%
transmute(sample_id,
failed_conditions = "Low read counts")
) %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id)) %>%   # ðŸ‘ˆ normalize IDs
group_by(sample_id) %>%
summarise(
failed_conditions = paste(unique(failed_conditions), collapse = ", "),
.groups = "drop"
) %>%
mutate(remarks = "For repeat testing")
if (nrow(reco_df) == 0) { failed_conditions <- "No further action required for this batch."}
colnames(reco_df) <- c('Sample ID','Reason - Failed Metrics','Remarks')
reco_table <- reco_df %>%
kable(
format = "latex",
booktabs = TRUE,
escape = TRUE,  # Keep FALSE since you pre-escaped underscores
align = c("l", "c", "c")
) %>%
kable_styling(
position = "left",
latex_options = c("striped", "hold_position")
) %>%
column_spec(1, width = "6cm") %>%
column_spec(2, width = "6cm") %>%
column_spec(3, width = "4cm") %>%
row_spec(0, background = "#D4D4D4", bold = TRUE)
reco_table
if(nrow(wgs_df) != 0){
rmarkdown::render("wgs_qc_report_ver2.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.pdf', sep='')
)
}else{
cat("No file found")
}
