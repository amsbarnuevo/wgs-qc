'<span style="background-color: #006b54; color: white; padding: 2px 6px; border-radius: 4px;">PASSED</span> | ',
'<span style="background-color: #ffd858; padding: 2px 6px; border-radius: 4px;">WARNING</span> | ',
'<span style="background-color: #D2042D; color: white; padding: 2px 6px; border-radius: 4px;">FAILED</span>'
))
datatable(assembly_qc_value,
escape = FALSE,
extensions = 'Buttons',
rownames = FALSE,
class = 'cell-border stripe',
caption = tags$caption(style = 'caption-side: bottom; text-align: left;', legend_html),
options = list(
dom = 'lBfrtip',
#buttons = c('copy', 'csv', 'excel'),
pageLength = 10,
lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'All')),
scrollX = TRUE,
# --- Centering the Body Data ---
columnDefs = list(
list(className = 'dt-center', targets = "_all") # Forces center alignment for all body cells
),
# --- Centering and Styling the Header ---
initComplete = JS(
"function(settings, json) {",
"$(this.api().table().header()).css({",
"  'background-color': '#D4D4D4',",
"  'color': 'black'",
"});",
# Specifically target the header 'th' elements for centering
"$(this.api().table().header()).find('th').css('text-align', 'center');",
"}"
)
)
) %>%
# --- 4. Apply Cell Background Colors ---
formatStyle(
c('Raw Reads Result', 'Assembly Result'),
target = 'cell',
backgroundColor = styleEqual(
c('PASSED', 'WARNING', 'FAILED'),
c('#006b54', '#ffd858', '#D2042D')
),
color = styleEqual(
c('PASSED', 'WARNING', 'FAILED'),
c('white', 'black', 'white')
),
fontWeight = 'bold',
textAlign = 'center' # Double-ensures text within these colored cells is centered
) %>% # Apply formatting to specific columns (analogous to column_spec)
formatStyle(
columns = 3, # Species columns
fontStyle = 'italic'
)
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
# --- 1. Prepare Data ---
# Convert everything to character to support the HTML injected by the loop
assembly_qc_value[] <- lapply(assembly_qc_value, as.character)
# --- 2. Loop for Specific Cell Failures (Failed Indices) ---
for (i in 1:nrow(assembly_qc_result)) {
if (!is.na(assembly_qc_result$failed_idx[i]) && nzchar(assembly_qc_result$failed_idx[i])) {
indices <- tryCatch({
as.numeric(trimws(unlist(strsplit(assembly_qc_result$failed_idx[i], ","))))
}, error = function(e) numeric(0))
indices <- indices[!is.na(indices) & indices > 0]
for (col in indices) {
if (col <= ncol(assembly_qc_value)) {
assembly_qc_value[i, col] <- cell_spec(
assembly_qc_value[i, col],
format = "html",
background = "#D2042D",
color = "white",
bold = TRUE
)
}
}
}
}
# --- 3. Generate Interactive Table ---
legend_html <- HTML(paste0(
"<strong>Legend: </strong>",
'<span style="background-color: #006b54; color: white; padding: 2px 6px; border-radius: 4px;">PASSED</span> | ',
'<span style="background-color: #ffd858; padding: 2px 6px; border-radius: 4px;">WARNING</span> | ',
'<span style="background-color: #D2042D; color: white; padding: 2px 6px; border-radius: 4px;">FAILED</span>'
))
datatable(assembly_qc_value,
escape = FALSE,
rownames = FALSE,
class = 'cell-border stripe',
caption = tags$caption(style = 'caption-side: bottom; text-align: left;', legend_html),
options = list(
dom = 'lBfrtip',
pageLength = 10,
lengthMenu = list(c(10, 25, 50, -1), c('10', '25', '50', 'All')),
scrollX = TRUE,
# --- Centering the Body Data ---
columnDefs = list(
list(className = 'dt-center', targets = "_all") # Forces center alignment for all body cells
),
# --- Centering and Styling the Header ---
initComplete = JS(
"function(settings, json) {",
"$(this.api().table().header()).css({",
"  'background-color': '#D4D4D4',",
"  'color': 'black'",
"});",
# Specifically target the header 'th' elements for centering
"$(this.api().table().header()).find('th').css('text-align', 'center');",
"}"
)
)
) %>%
# --- 4. Apply Cell Background Colors ---
formatStyle(
c('Raw Reads Result', 'Assembly Result'),
target = 'cell',
backgroundColor = styleEqual(
c('PASSED', 'WARNING', 'FAILED'),
c('#006b54', '#ffd858', '#D2042D')
),
color = styleEqual(
c('PASSED', 'WARNING', 'FAILED'),
c('white', 'black', 'white')
),
fontWeight = 'bold',
textAlign = 'center' # Double-ensures text within these colored cells is centered
) %>% # Apply formatting to specific columns (analogous to column_spec)
formatStyle(
columns = 3, # Species columns
fontStyle = 'italic'
)
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
assembly_failed <- assembly_qc_checked %>% filter(!is.na(failed_conditions))
if (nrow(assembly_failed) !=0) {
assembly_reco_df <- assembly_failed %>% select(sample_id, failed_conditions) %>%
mutate(failed_conditions = paste(unique(failed_conditions), collapse = ", ")) %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id))
} else {
sample_id <- ""
failed_conditions <- "No further action required for this batch."
assembly_reco_df <- data.frame(sample_id,failed_conditions, remarks)
}
colnames(assembly_reco_df) <- c('Sample ID','Reason - Failed Metrics')
# Render Interactive Table
datatable(assembly_reco_df,
#extensions = 'Buttons',
rownames = FALSE,
class = 'cell-border stripe',
options = list(
dom = 't', # Buttons, Length, filter, processing, table, info, pagination
buttons = c('copy', 'csv', 'excel'),
lengthMenu = list(c(5, 10, 25, -1), c('5', '10', '25', 'All')),
pageLength = 10,
scrollX = TRUE, # Important for long comma-separated lists
columnDefs = list(
list(targets = 0, className = 'dt-left'),  # Sample IDs left aligned
list(targets = 1, className = 'dt-center') # Remarks center aligned
),
initComplete = JS(
"function(settings, json) {",
"$(this.api().table().header()).css({'background-color': '#D4D4D4', 'color': 'black'});",
"$(this.api().table().header()).find('th').css('text-align', 'center');",
"}"
)
)
)
# --- Process Data (Logic remains the same) ---
overall_reco <- assembly_qc_checked %>%
filter(raw_reads_result == "FAILED" | assembly_result == "FAILED") %>%
select(sample_id, raw_reads_result, assembly_result) %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id)) %>%
group_by(raw_reads_result, assembly_result) %>%
summarize(sample_id = paste0(sample_id, collapse = ", "), .groups = 'drop')
overall_reco <- overall_reco %>%
mutate(final_result = case_when(
raw_reads_result == "PASSED" & assembly_result == "PASSED" ~ "PASSED",
raw_reads_result == "FAILED" & assembly_result == "PASSED" ~ "PASSED",
raw_reads_result == "FAILED" & assembly_result == "FAILED" ~ "FAILED",
raw_reads_result == "PASSED" & assembly_result == "FAILED" ~ "FAILED",
.default = ""
))
# --- Conditional Rendering ---
if (nrow(overall_reco) != 0) {
overall_reco_df <- overall_reco %>%
relocate(sample_id, .before = raw_reads_result)
colnames(overall_reco_df) <- c("Sample ID", "Raw Reads Result", "Assembly Result", "Final Result")
datatable(overall_reco_df,
extensions = 'Buttons',
rownames = FALSE,
class = 'cell-border stripe',
options = list(
dom = 'lBfrtip',
buttons = c('copy', 'csv', 'excel'),
scrollX = TRUE,
columnDefs = list(
list(className = 'dt-center', targets = "_all"),
list(targets = 0, textAlign = 'left', width = '400px') # Sample IDs left aligned
),
initComplete = JS(
"function(settings, json) {",
"$(this.api().table().header()).css({'background-color': '#D4D4D4', 'color': 'black'});",
"$(this.api().table().header()).find('th').css('text-align', 'center');",
"}"
)
)
) %>%
formatStyle(
c('Raw Reads Result', 'Assembly Result', 'Final Result'),
target = 'cell',
backgroundColor = styleEqual(
c('PASSED', 'FAILED'),
c('#006b54', '#D2042D')
),
color = styleEqual(
c('PASSED', 'FAILED'),
c('white', 'white')
),
fontWeight = 'bold'
)
} else {
# --- No Actions Table ---
overall_reco_df <- data.frame(
"Sample ID" = "N/A",
"Remarks" = "No further action required for this batch."
)
datatable(overall_reco_df,
rownames = FALSE,
options = list(
dom = 't', # Just the table
initComplete = JS(
"function(settings, json) {",
"$(this.api().table().header()).css({'background-color': '#D4D4D4', 'color': 'black'});",
"$(this.api().table().header()).find('th').css('text-align', 'center');",
"}"
)
)
) %>%
formatStyle(names(overall_reco_df), textAlign = 'center')
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
# --- Process Data (Logic remains the same) ---
overall_reco <- assembly_qc_checked %>%
filter(raw_reads_result == "FAILED" | assembly_result == "FAILED") %>%
select(sample_id, raw_reads_result, assembly_result) %>%
mutate(sample_id = sub("(.*)_[^_]*$", "\\1", sample_id)) %>%
group_by(raw_reads_result, assembly_result) %>%
summarize(sample_id = paste0(sample_id, collapse = ", "), .groups = 'drop')
overall_reco <- overall_reco %>%
mutate(final_result = case_when(
raw_reads_result == "PASSED" & assembly_result == "PASSED" ~ "PASSED",
raw_reads_result == "FAILED" & assembly_result == "PASSED" ~ "PASSED",
raw_reads_result == "FAILED" & assembly_result == "FAILED" ~ "FAILED",
raw_reads_result == "PASSED" & assembly_result == "FAILED" ~ "FAILED",
.default = ""
))
# --- Conditional Rendering ---
if (nrow(overall_reco) != 0) {
overall_reco_df <- overall_reco %>%
relocate(sample_id, .before = raw_reads_result)
colnames(overall_reco_df) <- c("Sample ID", "Raw Reads Result", "Assembly Result", "Final Result")
datatable(overall_reco_df,
rownames = FALSE,
class = 'cell-border stripe',
options = list(
dom = 'lBfrtip',
scrollX = TRUE,
columnDefs = list(
list(className = 'dt-center', targets = "_all"),
list(targets = 0, textAlign = 'left', width = '400px') # Sample IDs left aligned
),
initComplete = JS(
"function(settings, json) {",
"$(this.api().table().header()).css({'background-color': '#D4D4D4', 'color': 'black'});",
"$(this.api().table().header()).find('th').css('text-align', 'center');",
"}"
)
)
) %>%
formatStyle(
c('Raw Reads Result', 'Assembly Result', 'Final Result'),
target = 'cell',
backgroundColor = styleEqual(
c('PASSED', 'FAILED'),
c('#006b54', '#D2042D')
),
color = styleEqual(
c('PASSED', 'FAILED'),
c('white', 'white')
),
fontWeight = 'bold'
)
} else {
# --- No Actions Table ---
overall_reco_df <- data.frame(
"Sample ID" = "N/A",
"Remarks" = "No further action required for this batch."
)
datatable(overall_reco_df,
rownames = FALSE,
options = list(
dom = 't', # Just the table
initComplete = JS(
"function(settings, json) {",
"$(this.api().table().header()).css({'background-color': '#D4D4D4', 'color': 'black'});",
"$(this.api().table().header()).find('th').css('text-align', 'center');",
"}"
)
)
) %>%
formatStyle(names(overall_reco_df), textAlign = 'center')
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
df_amrfinderplus1 <- df_amrfinderplus
#checkm2 column names to lower
names(df_amrfinderplus1) <- tolower(names(df_amrfinderplus1))
#Change Name to sample_id
names(df_amrfinderplus1)[names(df_amrfinderplus1) == 'name'] <- 'sample_id'
names(df_amrfinderplus1)[names(df_amrfinderplus1) == 'element symbol'] <- 'element_symbol'
#change "-" to "_" in sample_id column
df_amrfinderplus1$sample_id <- gsub("-", "_", df_amrfinderplus1$sample_id, fixed=TRUE)
#merge wgs_id from wgs_df to mlst_df to set as species value
df_amrfinderplus1 <- merge(df_amrfinderplus1,wgs_species,by = "sample_id")
#remove "quasi" to wgs_id column
df_amrfinderplus1$wgs_id <- gsub("quasi", "", df_amrfinderplus1$wgs_id, fixed=TRUE)
# Filter rows where 'name' contains the word "sample"
df_amrfinderplus1 <- df_amrfinderplus1[grepl(batch_name_clean, df_amrfinderplus1$sample_id), ]
#remove batch name in sample_id
df_amrfinderplus1$sample_id <- sub("(.*)_[^_]*$", "\\1", df_amrfinderplus1$sample_id)
amr_genes_species <- unique(df_amrfinderplus1$wgs_id)
#vector to hold list of amr gene datables
amr_gene_df_list = c()
for(i in amr_genes_species) {
df <- subset(df_amrfinderplus1, df_amrfinderplus1$wgs_id == i)
sample_id <- c(df$sample_id)
#create new dataframe to duplicate df_amrfinderplus1
amr_genes_df <- df_amrfinderplus1
#change "NA" to " " in subclass column
amr_genes_df$subclass <- gsub("NA", "", amr_genes_df$subclass, fixed=TRUE)
amr_genes_df$Newcols <- paste(amr_genes_df$type,amr_genes_df$subclass, sep = " ")
#change "/" to "/ " in sample_id column
amr_genes_df$Newcols <- gsub("/", "/ ", amr_genes_df$Newcols, fixed=TRUE)
#subset dataframe to retain needed columns only
amr_genes_df <- subset(amr_genes_df, select = c(sample_id,Newcols,element_symbol))
#convert multiple rows with same Newcols value to single row
amr_genes_df <- amr_genes_df %>%
group_by(Newcols, sample_id) %>%
summarize(Concat = paste0(element_symbol, collapse = ", "))
#Create new dataframe to summarize the result
amr_genes_df <- amr_genes_df  %>%
pivot_wider(names_from = Newcols,
values_from = Concat)
#assign new name to dataframe
nam <- paste("amr", i, sep = "_")
assign(nam, amr_genes_df[amr_genes_df$sample_id %in% sample_id, ])
amr_gene_df_list <- c(amr_gene_df_list, nam)
}
View(`amr_Acinetobacter baumannii`)
df_amrfinderplus1 <- df_amrfinderplus
#checkm2 column names to lower
names(df_amrfinderplus1) <- tolower(names(df_amrfinderplus1))
#Change Name to sample_id
names(df_amrfinderplus1)[names(df_amrfinderplus1) == 'name'] <- 'sample_id'
names(df_amrfinderplus1)[names(df_amrfinderplus1) == 'element symbol'] <- 'element_symbol'
#change "-" to "_" in sample_id column
df_amrfinderplus1$sample_id <- gsub("-", "_", df_amrfinderplus1$sample_id, fixed=TRUE)
#merge wgs_id from wgs_df to mlst_df to set as species value
df_amrfinderplus1 <- merge(df_amrfinderplus1,wgs_species,by = "sample_id")
#remove "quasi" to wgs_id column
df_amrfinderplus1$wgs_id <- gsub("quasi", "", df_amrfinderplus1$wgs_id, fixed=TRUE)
# Filter rows where 'name' contains the word "sample"
df_amrfinderplus1 <- df_amrfinderplus1[grepl(batch_name_clean, df_amrfinderplus1$sample_id), ]
#remove batch name in sample_id
df_amrfinderplus1$sample_id <- sub("(.*)_[^_]*$", "\\1", df_amrfinderplus1$sample_id)
amr_genes_species <- unique(df_amrfinderplus1$wgs_id)
#vector to hold list of amr gene datables
amr_gene_df_list = c()
for(i in amr_genes_species) {
df <- subset(df_amrfinderplus1, df_amrfinderplus1$wgs_id == i)
sample_id <- c(df$sample_id)
#create new dataframe to duplicate df_amrfinderplus1
amr_genes_df <- df_amrfinderplus1
#change "NA" to " " in subclass column
amr_genes_df$subclass <- gsub("NA", "", amr_genes_df$subclass, fixed=TRUE)
amr_genes_df$Newcols <- paste(amr_genes_df$type,amr_genes_df$subclass, sep = " ")
#change "/" to "/ " in sample_id column
amr_genes_df$Newcols <- gsub("/", "/ ", amr_genes_df$Newcols, fixed=TRUE)
#subset dataframe to retain needed columns only
amr_genes_df <- subset(amr_genes_df, select = c(sample_id,Newcols,element_symbol))
#convert multiple rows with same Newcols value to single row
amr_genes_df <- amr_genes_df %>%
group_by(Newcols, sample_id) %>%
summarize(Concat = paste0(element_symbol, collapse = ", "))
#Create new dataframe to summarize the result
amr_genes_df <- amr_genes_df  %>%
pivot_wider(names_from = Newcols,
values_from = Concat)
#assign new name to dataframe
nam <- paste("amr", i, sep = "_")
assign(nam, amr_genes_df[amr_genes_df$sample_id %in% sample_id, ])
amr_gene_df_list <- c(amr_gene_df_list, nam)
}
for(i in amr_gene_df_list) {
df_orig <- get(i)
wgs_species_1 <- wgs_species
# Remove batch name in sample_id
wgs_species_1$sample_id <- sub("(.*)_[^_]*$", "\\1", wgs_species_1$sample_id)
# Merge wgs_id from wgs_df to amr_gene to set as species value
df <- merge(df_orig, wgs_species_1, by = "sample_id")
# Change wgs_id to species
names(df)[names(df) == 'wgs_id'] <- 'species'
# Reorder column
df <- df %>% relocate(species, .after = sample_id)
# Remove columns with all NA values
df <- df[, colSums(is.na(df)) < nrow(df)]
# Get unique species value for the header
species_val <- unique(df$species)[1]
# Subset dataframe to retain needed columns (removing species column as it goes in header)
df_subset <- subset(df, select = -c(species))
# --- Create Custom Header (equivalent to add_header_above) ---
sketch <- htmltools::withTags(table(
class = 'display',
thead(
tr(
th(colspan = ncol(df_subset),
style = "text-align: left; font-style: italic; border-bottom: 1px solid #111;",
species_val)
),
tr(
lapply(colnames(df_subset), th, style = "text-align: center;")
)
)
))
# --- Create the interactive table ---
tbl <- datatable(df_subset,
container = sketch,
extensions = 'Buttons',
rownames = FALSE,
class = 'cell-border stripe',
options = list(
dom = 'lBfrtip',
buttons = c('copy', 'csv', 'excel'),
pageLength = 10,
scrollX = TRUE, # Essential for tables with many gene columns
columnDefs = list(
list(className = 'dt-center', targets = "_all"),
list(width = '200px', targets = "_all") # Prevents columns from being too cramped
),
initComplete = JS(
"function(settings, json) {",
"$(this.api().table().header()).find('tr:eq(1) th').css({",
"  'background-color': '#D4D4D4',",
"  'color': 'black'",
"});",
"}"
)
)
)
# Output the HTML table
cat(as.character(htmltools::tagList(tbl)))
cat("\n\n")
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
if(nrow(wgs_result_df) != 0){
rmarkdown::render("wgs_qc_report_html.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.html', sep='')
)
}
View(qualibact_ref)
gc()
