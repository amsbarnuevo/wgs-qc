"Excel/counter/eco_referral_count.xlsx",f_site, eco_unusual_clean, 15, "first")
kpn_unusual_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae}','\\textit{Klebsiella pneumoniae}','kpn',
"Excel/counter/kpn_referral_count.xlsx",f_site, kpn_unusual_clean, 15, "first")
kpn_neo_unusual_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} (Neonates)','\\textit{Klebsiella pneumoniae}','kpn_neo',
"Excel/counter/kpn_neo_referral_count.xlsx",f_site, kpn_neo_unusual_clean, 15, "first")
aba_unusual_referral <- unusual_counter('\\\\textit{Acinetobacter baumanni}', '\\textit{Acinetobacter baumanni}','aba',
"Excel/counter/aba_referral_count.xlsx",f_site, aba_unusual_clean, 15, "first")
pae_unusual_referral <- unusual_counter('\\\\textit{Pseudomonas aeruginosa}', '\\textit{Pseudomonas aeruginosa}','pae',
"Excel/counter/pae_referral_count.xlsx",f_site, pae_unusual_clean, 15, "first")
efa_unusual_referral <- unusual_counter('\\\\textit{Enterococcus faecalis}', '\\textit{Enterococcus faecalis}','efa',
"Excel/counter/efa_referral_count.xlsx",f_site, efa_unusual_clean, 15, "first")
efm_unusual_referral <- unusual_counter('\\\\textit{Enterococcus faecium}', '\\textit{Enterococcus faecium}','efm',
"Excel/counter/efm_referral_count.xlsx",f_site, efm_unusual_clean, 15, "first")
bs_unusual_referral <- unusual_counter('Beta-Hemolytic \\\\textit{streptococci}', 'Beta-Hemolytic \\textit{streptococci}','bs',
"Excel/counter/bs_referral_count.xlsx",f_site, bs_unusual_clean, 15, "first")
sau_unusual_referral <- unusual_counter('\\\\textit{Staphylococcus aureus}', '\\textit{Staphylococcus aureus}','sau',
"Excel/counter/sau_referral_count.xlsx",f_site, sau_unusual_clean, 15, "first")
#check result for pan-susceptible
eco_pan_s_referral <- unusual_counter("\\\\textit{Escherichia coli} - Pan-susceptible isolates", '\\textit{Escherichia coli}','eco',
"Excel/counter/eco_pan_s_count.xlsx",f_site, eco_pan_s_unusual_clean , 5, "pan")
kpn_pan_s_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} - Pan-susceptible isolates', '\\textit{Klebsiella pneumoniae}','kpn',
"Excel/counter/kpn_pan_s_count.xlsx",f_site, kpn_pan_s_unusual_clean , 10, "pan")
kpn_neo_pan_s_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} (Neonates) - Pan-susceptible isolates',
'\\textit{Klebsiella pneumoniae}','kpn_neo',"Excel/counter/kpn_neo_pan_s_count.xlsx",
f_site, kpn_neo_pan_s_unusual_clean , 10, "pan")
aba_pan_s_referral <- unusual_counter('\\\\textit{Acinetobacter baumanni} - Pan-susceptible isolates', '\\textit{Acinetobacter baumanni}','aba',
"Excel/counter/aba_pan_s_count.xlsx",f_site, aba_pan_s_unusual_clean , 5, "pan")
pae_pan_s_referral <- unusual_counter('\\\\textit{Pseudomonas aeruginosa} - Pan-susceptible isolates', '\\textit{Pseudomonas aeruginosa}','pae',
"Excel/counter/pae_pan_s_count.xlsx",f_site, pae_pan_s_unusual_clean , 5, "pan")
efa_pan_s_referral <- unusual_counter('\\\\textit{Enterococcus faecalis} - Pan-susceptible isolates', '\\textit{Enterococcus faecalis}','efa',
"Excel/counter/efa_pan_s_count.xlsx",f_site, efa_pan_s_unusual_clean , 5, "pan")
bs_pan_s_referral <- unusual_counter('Beta-Hemolytic \\\\textit{streptococci} - Pan-susceptible isolates',
'Beta-Hemolytic \\textit{streptococci}','bs',"Excel/counter/bs_pan_s_count.xlsx",
f_site, bs_pan_s_unusual_clean , 5, "pan")
sau_pan_s_referral <- unusual_counter('\\\\textit{Staphylococcus aureus} - Pan-susceptible isolates', '\\textit{Staphylococcus aureus}','sau',
"Excel/counter/sau_pan_s_count.xlsx",f_site, sau_pan_s_unusual_clean , 5, "pan")
View(kpn_pan_s_referral)
unusual_list_summary <- data.frame(org_name=character(),
ref_count_df=integer(),
stringsAsFactors=FALSE)
unusual_counter <- function(org_header, org_name, org_code, count_df, sheetname, unusual_df, count, ref_days) {
if (!is.data.frame(unusual_df) || nrow(unusual_df) == 0) {
# Case: empty or invalid input
referral_tc <- data.frame(org_name = org_name, ref_count_df = 0)
unusual_list_summary <<- rbind(referral_tc, unusual_list_summary)
return(data.frame(unusual_clean))
#return(list(unusual_df, referral_tc))
}
# Load existing sheet
referral_count_df <- read_xlsx(count_df, sheet = sheetname)
row_count <- nrow(referral_count_df)
unusual_df$patient_id <- as.character(unusual_df$patient_id)
# If max count already met
if (row_count >= count) {
referral_tc <- data.frame(org_name = org_name, ref_count_df = 0)
return(list(unusual_df[unusual_df$ref_days != ref_days, ], referral_tc))
}
# Filter only the rows for specified referral day type
unusual_ref <- unusual_df[unusual_df$ref_days == ref_days, ]
remaining_count <- count - row_count
# Determine rows to append
if (nrow(unusual_ref) > remaining_count) {
unusual_list <- unusual_ref[1:remaining_count, ]
keep_ids <- unusual_list$patient_id
unusual_clean <- unusual_df[unusual_df$patient_id %in% keep_ids, ]
} else {
unusual_list <- unusual_ref
unusual_clean <- unusual_df
}
# Columns to append
unusual_list_data <- unusual_list %>%
select(patient_id, sex, age, date_admis, spec_num, spec_date, spec_type, organism, induc_cli, esbl, RIS)
# Read and update Excel workbook
#wb <- loadWorkbook(count_df)
#dat <- readWorkbook(count_df, sheet = sheetname)
#dat <- bind_rows(dat %>% mutate_all(as.character), unusual_list_data %>% mutate_all(as.character))
#writeData(wb, sheetname, dat)
#saveWorkbook(wb, count_df, overwrite = TRUE)
unusual_list_data <- unusual_list %>% mutate(org_header = org_header)
# Prepare final summary
referral_tc <- data.frame(org_name = org_name, ref_count_df = nrow(unusual_clean))
unusual_list_summary <<- rbind(referral_tc, unusual_list_summary)
return(data.frame(unusual_clean))
#return(list(data.frame(unusual_clean), data.frame(referral_tc)))
}
eco_unusual_referral <- unusual_counter("\\\\textit{Escherichia coli}",'\\textit{Escherichia coli}','eco',
"Excel/counter/eco_referral_count.xlsx",f_site, eco_unusual_clean, 15, "first")
kpn_unusual_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae}','\\textit{Klebsiella pneumoniae}','kpn',
"Excel/counter/kpn_referral_count.xlsx",f_site, kpn_unusual_clean, 15, "first")
kpn_neo_unusual_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} (Neonates)','\\textit{Klebsiella pneumoniae}','kpn_neo',
"Excel/counter/kpn_neo_referral_count.xlsx",f_site, kpn_neo_unusual_clean, 15, "first")
aba_unusual_referral <- unusual_counter('\\\\textit{Acinetobacter baumanni}', '\\textit{Acinetobacter baumanni}','aba',
"Excel/counter/aba_referral_count.xlsx",f_site, aba_unusual_clean, 15, "first")
pae_unusual_referral <- unusual_counter('\\\\textit{Pseudomonas aeruginosa}', '\\textit{Pseudomonas aeruginosa}','pae',
"Excel/counter/pae_referral_count.xlsx",f_site, pae_unusual_clean, 15, "first")
efa_unusual_referral <- unusual_counter('\\\\textit{Enterococcus faecalis}', '\\textit{Enterococcus faecalis}','efa',
"Excel/counter/efa_referral_count.xlsx",f_site, efa_unusual_clean, 15, "first")
efm_unusual_referral <- unusual_counter('\\\\textit{Enterococcus faecium}', '\\textit{Enterococcus faecium}','efm',
"Excel/counter/efm_referral_count.xlsx",f_site, efm_unusual_clean, 15, "first")
bs_unusual_referral <- unusual_counter('Beta-Hemolytic \\\\textit{streptococci}', 'Beta-Hemolytic \\textit{streptococci}','bs',
"Excel/counter/bs_referral_count.xlsx",f_site, bs_unusual_clean, 15, "first")
sau_unusual_referral <- unusual_counter('\\\\textit{Staphylococcus aureus}', '\\textit{Staphylococcus aureus}','sau',
"Excel/counter/sau_referral_count.xlsx",f_site, sau_unusual_clean, 15, "first")
#check result for pan-susceptible
eco_pan_s_referral <- unusual_counter("\\\\textit{Escherichia coli} - Pan-susceptible isolates", '\\textit{Escherichia coli}','eco',
"Excel/counter/eco_pan_s_count.xlsx",f_site, eco_pan_s_unusual_clean , 5, "pan")
kpn_pan_s_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} - Pan-susceptible isolates', '\\textit{Klebsiella pneumoniae}','kpn',
"Excel/counter/kpn_pan_s_count.xlsx",f_site, kpn_pan_s_unusual_clean , 10, "pan")
kpn_neo_pan_s_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} (Neonates) - Pan-susceptible isolates',
'\\textit{Klebsiella pneumoniae}','kpn_neo',"Excel/counter/kpn_neo_pan_s_count.xlsx",
f_site, kpn_neo_pan_s_unusual_clean , 10, "pan")
aba_pan_s_referral <- unusual_counter('\\\\textit{Acinetobacter baumanni} - Pan-susceptible isolates', '\\textit{Acinetobacter baumanni}','aba',
"Excel/counter/aba_pan_s_count.xlsx",f_site, aba_pan_s_unusual_clean , 5, "pan")
pae_pan_s_referral <- unusual_counter('\\\\textit{Pseudomonas aeruginosa} - Pan-susceptible isolates', '\\textit{Pseudomonas aeruginosa}','pae',
"Excel/counter/pae_pan_s_count.xlsx",f_site, pae_pan_s_unusual_clean , 5, "pan")
efa_pan_s_referral <- unusual_counter('\\\\textit{Enterococcus faecalis} - Pan-susceptible isolates', '\\textit{Enterococcus faecalis}','efa',
"Excel/counter/efa_pan_s_count.xlsx",f_site, efa_pan_s_unusual_clean , 5, "pan")
bs_pan_s_referral <- unusual_counter('Beta-Hemolytic \\\\textit{streptococci} - Pan-susceptible isolates',
'Beta-Hemolytic \\textit{streptococci}','bs',"Excel/counter/bs_pan_s_count.xlsx",
f_site, bs_pan_s_unusual_clean , 5, "pan")
sau_pan_s_referral <- unusual_counter('\\\\textit{Staphylococcus aureus} - Pan-susceptible isolates', '\\textit{Staphylococcus aureus}','sau',
"Excel/counter/sau_pan_s_count.xlsx",f_site, sau_pan_s_unusual_clean , 5, "pan")
unusual_list_summary <- data.frame(org_name=character(),
ref_count_df=integer(),
stringsAsFactors=FALSE)
unusual_counter <- function(org_header, org_name, org_code, count_df, sheetname, unusual_df, count, ref_days) {
if (!is.data.frame(unusual_df) || nrow(unusual_df) == 0) {
# Case: empty or invalid input
referral_tc <- data.frame(org_name = org_name, ref_count_df = 0)
return(list(unusual_df, referral_tc))
}
# Load existing sheet
referral_count_df <- read_xlsx(count_df, sheet = sheetname)
row_count <- nrow(referral_count_df)
unusual_df$patient_id <- as.character(unusual_df$patient_id)
# If max count already met
if (row_count >= count) {
referral_tc <- data.frame(org_name = org_name, ref_count_df = 0)
return(list(unusual_df[unusual_df$ref_days != ref_days, ], referral_tc))
}
# Filter only the rows for specified referral day type
unusual_ref <- unusual_df[unusual_df$ref_days == ref_days, ]
remaining_count <- count - row_count
# Determine rows to append
if (nrow(unusual_ref) > remaining_count) {
unusual_list <- unusual_ref[1:remaining_count, ]
keep_ids <- unusual_list$patient_id
unusual_clean <- unusual_df[unusual_df$patient_id %in% keep_ids, ]
} else {
unusual_list <- unusual_ref
unusual_clean <- unusual_df
}
# Columns to append
unusual_list_data <- unusual_list %>%
select(patient_id, sex, age, date_admis, spec_num, spec_date, spec_type, organism, induc_cli, esbl, RIS)
# Read and update Excel workbook
#wb <- loadWorkbook(count_df)
#dat <- readWorkbook(count_df, sheet = sheetname)
#dat <- bind_rows(dat %>% mutate_all(as.character), unusual_list_data %>% mutate_all(as.character))
#writeData(wb, sheetname, dat)
#saveWorkbook(wb, count_df, overwrite = TRUE)
unusual_list_data <- unusual_list %>% mutate(org_header = org_header)
# Prepare final summary
referral_tc <- data.frame(org_name = org_name, ref_count_df = nrow(unusual_clean))
unusual_list_summary <<- rbind(referral_tc, unusual_list_summary)
#return(data.frame(unusual_clean))
return(list(data.frame(unusual_clean), data.frame(referral_tc)))
}
eco_unusual_referral <- unusual_counter("\\\\textit{Escherichia coli}",'\\textit{Escherichia coli}','eco',
"Excel/counter/eco_referral_count.xlsx",f_site, eco_unusual_clean, 15, "first")
kpn_unusual_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae}','\\textit{Klebsiella pneumoniae}','kpn',
"Excel/counter/kpn_referral_count.xlsx",f_site, kpn_unusual_clean, 15, "first")
kpn_neo_unusual_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} (Neonates)','\\textit{Klebsiella pneumoniae}','kpn_neo',
"Excel/counter/kpn_neo_referral_count.xlsx",f_site, kpn_neo_unusual_clean, 15, "first")
aba_unusual_referral <- unusual_counter('\\\\textit{Acinetobacter baumanni}', '\\textit{Acinetobacter baumanni}','aba',
"Excel/counter/aba_referral_count.xlsx",f_site, aba_unusual_clean, 15, "first")
pae_unusual_referral <- unusual_counter('\\\\textit{Pseudomonas aeruginosa}', '\\textit{Pseudomonas aeruginosa}','pae',
"Excel/counter/pae_referral_count.xlsx",f_site, pae_unusual_clean, 15, "first")
efa_unusual_referral <- unusual_counter('\\\\textit{Enterococcus faecalis}', '\\textit{Enterococcus faecalis}','efa',
"Excel/counter/efa_referral_count.xlsx",f_site, efa_unusual_clean, 15, "first")
efm_unusual_referral <- unusual_counter('\\\\textit{Enterococcus faecium}', '\\textit{Enterococcus faecium}','efm',
"Excel/counter/efm_referral_count.xlsx",f_site, efm_unusual_clean, 15, "first")
bs_unusual_referral <- unusual_counter('Beta-Hemolytic \\\\textit{streptococci}', 'Beta-Hemolytic \\textit{streptococci}','bs',
"Excel/counter/bs_referral_count.xlsx",f_site, bs_unusual_clean, 15, "first")
sau_unusual_referral <- unusual_counter('\\\\textit{Staphylococcus aureus}', '\\textit{Staphylococcus aureus}','sau',
"Excel/counter/sau_referral_count.xlsx",f_site, sau_unusual_clean, 15, "first")
#check result for pan-susceptible
eco_pan_s_referral <- unusual_counter("\\\\textit{Escherichia coli} - Pan-susceptible isolates", '\\textit{Escherichia coli}','eco',
"Excel/counter/eco_pan_s_count.xlsx",f_site, eco_pan_s_unusual_clean , 5, "pan")
kpn_pan_s_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} - Pan-susceptible isolates', '\\textit{Klebsiella pneumoniae}','kpn',
"Excel/counter/kpn_pan_s_count.xlsx",f_site, kpn_pan_s_unusual_clean , 10, "pan")
kpn_neo_pan_s_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} (Neonates) - Pan-susceptible isolates',
'\\textit{Klebsiella pneumoniae}','kpn_neo',"Excel/counter/kpn_neo_pan_s_count.xlsx",
f_site, kpn_neo_pan_s_unusual_clean , 10, "pan")
aba_pan_s_referral <- unusual_counter('\\\\textit{Acinetobacter baumanni} - Pan-susceptible isolates', '\\textit{Acinetobacter baumanni}','aba',
"Excel/counter/aba_pan_s_count.xlsx",f_site, aba_pan_s_unusual_clean , 5, "pan")
pae_pan_s_referral <- unusual_counter('\\\\textit{Pseudomonas aeruginosa} - Pan-susceptible isolates', '\\textit{Pseudomonas aeruginosa}','pae',
"Excel/counter/pae_pan_s_count.xlsx",f_site, pae_pan_s_unusual_clean , 5, "pan")
efa_pan_s_referral <- unusual_counter('\\\\textit{Enterococcus faecalis} - Pan-susceptible isolates', '\\textit{Enterococcus faecalis}','efa',
"Excel/counter/efa_pan_s_count.xlsx",f_site, efa_pan_s_unusual_clean , 5, "pan")
bs_pan_s_referral <- unusual_counter('Beta-Hemolytic \\\\textit{streptococci} - Pan-susceptible isolates',
'Beta-Hemolytic \\textit{streptococci}','bs',"Excel/counter/bs_pan_s_count.xlsx",
f_site, bs_pan_s_unusual_clean , 5, "pan")
sau_pan_s_referral <- unusual_counter('\\\\textit{Staphylococcus aureus} - Pan-susceptible isolates', '\\textit{Staphylococcus aureus}','sau',
"Excel/counter/sau_pan_s_count.xlsx",f_site, sau_pan_s_unusual_clean , 5, "pan")
View(unusual_list_summary)
#Merge result count of unusual and pan-s results
unusual_list <- rbind(hin_unusual_referral[[2]],ngo_unusual_referral[[2]],nme_unusual_referral[[2]],spn_unusual_referral[[2]],e157_unusual_referral[[2]],sal_unusual_referral[[2]],shi_unusual_referral[[2]],vic_unusual_referral[[2]], unusual_list_summary)
unusual_list <- unusual_list %>%
group_by(org_name) %>%
summarise(ref_count_df = sum(ref_count_df))
unusual_list[unusual_list==0] <- NA
unusual_list <- unusual_list[complete.cases(unusual_list),]
unusual_list_vector <- str_extract_all(unusual_list$org_name, "(?<=\\{).+?(?=\\})")
unusual_list_vector <<- unlist(unusual_list_vector)
write.csv(unusual_list, file="Excel/unusual_list_df.csv")
unusual_list <- rbind(hin_unusual_referral[[2]],ngo_unusual_referral[[2]],nme_unusual_referral[[2]],spn_unusual_referral[[2]],e157_unusual_referral[[2]],sal_unusual_referral[[2]],shi_unusual_referral[[2]],vic_unusual_referral[[2]], unusual_list_summary)
View(unusual_list)
unusual_list <- unusual_list %>%
group_by(org_name) %>%
summarise(ref_count_df = sum(ref_count_df))
unusual_list[unusual_list==0] <- NA
unusual_list <- unusual_list[complete.cases(unusual_list),]
unusual_list_vector <- str_extract_all(unusual_list$org_name, "(?<=\\{).+?(?=\\})")
unusual_list_vector <<- unlist(unusual_list_vector)
View(unusual_list)
unusual_list <- rbind(hin_unusual_referral[[2]],ngo_unusual_referral[[2]],nme_unusual_referral[[2]],spn_unusual_referral[[2]],e157_unusual_referral[[2]],sal_unusual_referral[[2]],shi_unusual_referral[[2]],vic_unusual_referral[[2]], unusual_list_summary)
View(sau_unusual_referral)
View(sau_unusual_result)
unusual_list <- c("eco_unusual_referral", "kpn_unusual_referral", "kpn_neo_unusual_referral", "aba_unusual_referral", "pae_unusual_referral",
"efa_unusual_referral", "efm_unusual_referral", "bs_unusual_referral", "sau_unusual_referral", "eco_pan_s_referral",
"kpn_pan_s_referral", "kpn_neo_pan_s_referral", "aba_pan_s_referral", "pae_pan_s_referral", "efa_pan_s_referral",
"bs_pan_s_referral", "sau_pan_s_referral")
for (i in unusual_list) {
ref_obj <- get(i)
unusual_df <- ref_obj[[1]]  # extract the first dataframe
if (is.data.frame(unusual_df) && nrow(unusual_df) > 0 && any(!is.na(unusual_df))) {
org_name <- unique(unusual_df$org_name)
unusual_table_growth = subset(unusual_df, select = -c(ref_days, RIS))
names(unusual_table_growth) <- toupper(names(unusual_table_growth))
colnames(unusual_table_growth)[1:10] <- c('ID No','SP Num','Sex','Age','Date_adm','SP Date','SP Type','Org','ICR','ESBL')
ncol <- ncol(unusual_table_growth)
unusual_table <- kable(unusual_table_growth, align = "c") %>%
kable_styling(latex_options = c("hold_position","scale_down"), position = "left") %>%
add_header_above(setNames(ncol,org_name), bold = TRUE, escape = FALSE, font_size = 10, align = "l")
print(unusual_table)
cat("\\vspace{1em}")
}
}
View(sau_unusual_referral)
View(sau_unusual_referral[[2]])
View(sau_unusual_referral[[1]])
View(sau_unusual_referral[[2]])
View(hin_unusual_referral)
View(hin_unusual_referral[[1]])
View(kpn_pan_s_referral)
View(kpn_pan_s_referral[[1]])
unusual_list_summary <- data.frame(org_name=character(),
ref_count_df=integer(),
stringsAsFactors=FALSE)
unusual_counter <- function(org_header, org_name, org_code, count_df, sheetname, unusual_df, count, ref_days) {
if (!is.data.frame(unusual_df) || nrow(unusual_df) == 0) {
# Case: empty or invalid input
referral_tc <- data.frame(org_name = org_name, ref_count_df = 0)
return(list(unusual_df, referral_tc))
}
# Load existing sheet
referral_count_df <- read_xlsx(count_df, sheet = sheetname)
row_count <- nrow(referral_count_df)
unusual_df$patient_id <- as.character(unusual_df$patient_id)
# If max count already met
if (row_count >= count) {
referral_tc <- data.frame(org_name = org_name, ref_count_df = 0)
return(list(unusual_df[unusual_df$ref_days != ref_days, ], referral_tc))
}
# Filter only the rows for specified referral day type
unusual_ref <- unusual_df[unusual_df$ref_days == ref_days, ]
remaining_count <- count - row_count
# Determine rows to append
if (nrow(unusual_ref) > remaining_count) {
unusual_list <- unusual_ref[1:remaining_count, ]
keep_ids <- unusual_list$patient_id
unusual_clean <- unusual_df[unusual_df$patient_id %in% keep_ids, ]
} else {
unusual_list <- unusual_ref
unusual_clean <- unusual_df
}
# Columns to append
unusual_list_data <- unusual_list %>%
select(patient_id, sex, age, date_admis, spec_num, spec_date, spec_type, organism, induc_cli, esbl, RIS)
# Read and update Excel workbook
#wb <- loadWorkbook(count_df)
#dat <- readWorkbook(count_df, sheet = sheetname)
#dat <- bind_rows(dat %>% mutate_all(as.character), unusual_list_data %>% mutate_all(as.character))
#writeData(wb, sheetname, dat)
#saveWorkbook(wb, count_df, overwrite = TRUE)
unusual_clean <- unusual_clean %>% mutate(org_header = org_header)
unusual_list_data <- unusual_list %>% mutate(org_header = org_header)
# Prepare final summary
referral_tc <- data.frame(org_name = org_name, ref_count_df = nrow(unusual_clean))
unusual_list_summary <<- rbind(referral_tc, unusual_list_summary)
#return(data.frame(unusual_clean))
return(list(data.frame(unusual_clean), data.frame(referral_tc)))
}
eco_unusual_referral <- unusual_counter("\\\\textit{Escherichia coli}",'\\textit{Escherichia coli}','eco',
"Excel/counter/eco_referral_count.xlsx",f_site, eco_unusual_clean, 15, "first")
kpn_unusual_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae}','\\textit{Klebsiella pneumoniae}','kpn',
"Excel/counter/kpn_referral_count.xlsx",f_site, kpn_unusual_clean, 15, "first")
kpn_neo_unusual_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} (Neonates)','\\textit{Klebsiella pneumoniae}','kpn_neo',
"Excel/counter/kpn_neo_referral_count.xlsx",f_site, kpn_neo_unusual_clean, 15, "first")
aba_unusual_referral <- unusual_counter('\\\\textit{Acinetobacter baumanni}', '\\textit{Acinetobacter baumanni}','aba',
"Excel/counter/aba_referral_count.xlsx",f_site, aba_unusual_clean, 15, "first")
pae_unusual_referral <- unusual_counter('\\\\textit{Pseudomonas aeruginosa}', '\\textit{Pseudomonas aeruginosa}','pae',
"Excel/counter/pae_referral_count.xlsx",f_site, pae_unusual_clean, 15, "first")
efa_unusual_referral <- unusual_counter('\\\\textit{Enterococcus faecalis}', '\\textit{Enterococcus faecalis}','efa',
"Excel/counter/efa_referral_count.xlsx",f_site, efa_unusual_clean, 15, "first")
efm_unusual_referral <- unusual_counter('\\\\textit{Enterococcus faecium}', '\\textit{Enterococcus faecium}','efm',
"Excel/counter/efm_referral_count.xlsx",f_site, efm_unusual_clean, 15, "first")
bs_unusual_referral <- unusual_counter('Beta-Hemolytic \\\\textit{streptococci}', 'Beta-Hemolytic \\textit{streptococci}','bs',
"Excel/counter/bs_referral_count.xlsx",f_site, bs_unusual_clean, 15, "first")
sau_unusual_referral <- unusual_counter('\\\\textit{Staphylococcus aureus}', '\\textit{Staphylococcus aureus}','sau',
"Excel/counter/sau_referral_count.xlsx",f_site, sau_unusual_clean, 15, "first")
#check result for pan-susceptible
eco_pan_s_referral <- unusual_counter("\\\\textit{Escherichia coli} - Pan-susceptible isolates", '\\textit{Escherichia coli}','eco',
"Excel/counter/eco_pan_s_count.xlsx",f_site, eco_pan_s_unusual_clean , 5, "pan")
kpn_pan_s_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} - Pan-susceptible isolates', '\\textit{Klebsiella pneumoniae}','kpn',
"Excel/counter/kpn_pan_s_count.xlsx",f_site, kpn_pan_s_unusual_clean , 10, "pan")
kpn_neo_pan_s_referral <- unusual_counter('\\\\textit{Klebsiella pneumoniae} (Neonates) - Pan-susceptible isolates',
'\\textit{Klebsiella pneumoniae}','kpn_neo',"Excel/counter/kpn_neo_pan_s_count.xlsx",
f_site, kpn_neo_pan_s_unusual_clean , 10, "pan")
aba_pan_s_referral <- unusual_counter('\\\\textit{Acinetobacter baumanni} - Pan-susceptible isolates', '\\textit{Acinetobacter baumanni}','aba',
"Excel/counter/aba_pan_s_count.xlsx",f_site, aba_pan_s_unusual_clean , 5, "pan")
pae_pan_s_referral <- unusual_counter('\\\\textit{Pseudomonas aeruginosa} - Pan-susceptible isolates', '\\textit{Pseudomonas aeruginosa}','pae',
"Excel/counter/pae_pan_s_count.xlsx",f_site, pae_pan_s_unusual_clean , 5, "pan")
efa_pan_s_referral <- unusual_counter('\\\\textit{Enterococcus faecalis} - Pan-susceptible isolates', '\\textit{Enterococcus faecalis}','efa',
"Excel/counter/efa_pan_s_count.xlsx",f_site, efa_pan_s_unusual_clean , 5, "pan")
bs_pan_s_referral <- unusual_counter('Beta-Hemolytic \\\\textit{streptococci} - Pan-susceptible isolates',
'Beta-Hemolytic \\textit{streptococci}','bs',"Excel/counter/bs_pan_s_count.xlsx",
f_site, bs_pan_s_unusual_clean , 5, "pan")
sau_pan_s_referral <- unusual_counter('\\\\textit{Staphylococcus aureus} - Pan-susceptible isolates', '\\textit{Staphylococcus aureus}','sau',
"Excel/counter/sau_pan_s_count.xlsx",f_site, sau_pan_s_unusual_clean , 5, "pan")
View(kpn_pan_s_referred)
View(kpn_pan_s_referral)
View(kpn_pan_s_referral[[1]])
unusual_list <- c("eco_unusual_referral", "kpn_unusual_referral", "kpn_neo_unusual_referral", "aba_unusual_referral", "pae_unusual_referral",
"efa_unusual_referral", "efm_unusual_referral", "bs_unusual_referral", "sau_unusual_referral", "eco_pan_s_referral",
"kpn_pan_s_referral", "kpn_neo_pan_s_referral", "aba_pan_s_referral", "pae_pan_s_referral", "efa_pan_s_referral",
"bs_pan_s_referral", "sau_pan_s_referral")
for (i in unusual_list) {
ref_obj <- get(i)
unusual_df <- ref_obj[[1]]  # extract the first dataframe
if (is.data.frame(unusual_df) && nrow(unusual_df) > 0 && any(!is.na(unusual_df))) {
org_name <- unique(unusual_df$org_header)
unusual_table_growth = subset(unusual_df, select = -c(ref_days, RIS, org_header))
names(unusual_table_growth) <- toupper(names(unusual_table_growth))
colnames(unusual_table_growth)[1:10] <- c('ID No','SP Num','Sex','Age','Date_adm','SP Date','SP Type','Org','ICR','ESBL')
ncol <- ncol(unusual_table_growth)
unusual_table <- kable(unusual_table_growth, align = "c") %>%
kable_styling(latex_options = c("hold_position","scale_down"), position = "left") %>%
add_header_above(setNames(ncol,org_name), bold = TRUE, escape = FALSE, font_size = 10, align = "l")
print(unusual_table)
cat("\\vspace{1em}")
}
}
gc()
source("E:/DMU Projects/referred_monitoring/ghru_kpn_tool.R", echo = TRUE)
# Load package
library(tidyverse)
library(knitr)
library(readxl)
library(kableExtra)
library(RColorBrewer)
library(scales)
library(readr)
library(DBI)
library(svDialogs)
library(writexl)
library(conflicted)
library(data.table)
library(googlesheets4)
conflicts_prefer(openxlsx::write.xlsx)
conflicts_prefer(dplyr::filter)
setwd("E:/DMU Projects/wgs-qc")
# Google Sheet ID extracted from the URL
sheet_id <- "1NHu-RIgDeTPKgrnTTHS9qVbCe04tIeYX6k73Jm93gDw"
# Read the sheet
df_batch <- read_sheet(sheet_id, sheet = "batch")
df_gambit <- read_sheet(sheet_id, sheet = "gambit")
df_fastp <- read_sheet(sheet_id, sheet = "fastp_summary")
df_assembly <- read_sheet(sheet_id, sheet = "assembly-scan")
df_checkm2 <- read_sheet(sheet_id, sheet = "checkm2")
df_mlst <- read_sheet(sheet_id, sheet = "mlst")
df_amrfinderplus <- read_sheet(sheet_id, sheet = "amrfinderplus")
# Read referred database
referred_sheet_id <- "1JKtyRyLh0-ck2xCk0oIH4iidgs21996UKj69lvvlXAU"
referred_df <- read_sheet(referred_sheet_id, sheet = 1)
# enter batch code
batch_code <- dlgInput("Enter Batch Code:", Sys.info()[" "])$res
#get samplesheet file
get_samplesheet <- dlgInput("Enter sample sheet file name:", Sys.info()[" "])$res
#filter batch df
batch_df <- df_batch[df_batch$batch_code == batch_code, ]
sample_name <- batch_df$sample_name
sample_name <- gsub("-", "_", sample_name, fixed=TRUE)
#remove batch number from sample_name
sample_name_clean <- sub("(.*)_[^_]*$", "\\1", sample_name)
#merge qualifyr, gambit,checkm2 and bactopia results
#rename column
colnames(df_gambit)[which(names(df_gambit) == "sample")] <- "name"
colnames(df_assembly)[which(names(df_assembly) == "sample")] <- "name"
colnames(df_fastp)[which(names(df_fastp) == "sample")] <- "name"
#checkm2 column names to lower
names(df_checkm2) <- tolower(names(df_checkm2))
#remove ".fna"
df_checkm2$name <- gsub(".fna", "", df_checkm2$name, fixed=TRUE)
# Get species name
df_gambit$species <- case_when(
df_gambit$predicted.rank == "species" ~ df_gambit$predicted.name,
TRUE ~ df_gambit$next.name
)
# Compute total GC Content
df_assembly$gc_content <- as.numeric(df_assembly$contig_percent_g) + as.numeric(df_assembly$contig_percent_c)
# Subset Columns per dataframe
gambit_sub_df <- subset(df_gambit, select = c(name, species))
checkm2_sub_df <- subset(df_checkm2, select = c(name, completeness, contamination))
assembly_sub_df <- subset(df_assembly, select = c(name, total_contig, total_contig_length, gc_content, n50_contig_length))
fastp_sub_df <- subset(df_fastp, select = c(name, after_total_bases, combined_qual_mean))
# put all data frames into list
df_list <- list(gambit_sub_df, checkm2_sub_df, assembly_sub_df, fastp_sub_df)
# merge all data frames in list
wgs_df <- df_list %>% reduce(full_join, by='name')
wgs_df$name <- gsub("-", "_", wgs_df$name, fixed=TRUE)
wgs_df$name <- toupper(wgs_df$name)
#filter wgs_df based on sample_name
wgs_df <- wgs_df[wgs_df$name %in% sample_name, ]
# Apply the function to the column of strings
wgs_df <- wgs_df %>% rename(sample_id = name)
#Check if STC sample is present in the id list
stc_sample <- grep("STC", wgs_df[['sample_id']], value = TRUE)
stc_sample_count <- length(stc_sample)
if (stc_sample_count !=0){
wgs_df$sample_id <- gsub("STC", "STC_", wgs_df$sample_id, fixed=TRUE)
}
referred_df <- subset(referred_df, select = c(accession_no,arsrl_org))
result <- referred_df[referred_df$accession_no %in% sample_name_clean, ]
colnames(result) <- c('sample_id','arsrl_org')
# Returns string without leading or trailing white space
result$arsrl_org <- gsub("^\\s+|\\s+$", "", result$arsrl_org)
#check if arsrl_result_df is exisiting
if (!exists("arsrl_result_df")) {
arsrl_result_df <- result
}
#Check if UTP sample is present in the id list
utp_sample <- grep("UTP", wgs_df[['sample_id']], value = TRUE)
utp_sample_count <- length(utp_sample)
if(utp_sample_count !=0){
sample_id = sub("(.*)_[^_]*$", "\\1", utp_sample)
arsrl_org = "Escherichia coli"
arsrl_result_df <- result %>%
add_row(sample_id = sample_id, arsrl_org=arsrl_org)
arsrl_result_df <- subset(arsrl_result_df , select = c(sample_id,arsrl_org))
colnames(arsrl_result_df) <- c('sample_id','arsrl_org')
}else{
arsrl_result_df <- subset(result , select = c(sample_id,arsrl_org))
colnames(arsrl_result_df) <- c('sample_id','arsrl_org')
}
#manually add result for STC
if(stc_sample_count !=0){
stc_df <- read_xlsx("data_files/ARSRL_SatScan_Results.xlsx")
stc_df <- stc_df[stc_df$sample_id %in% stc_sample, ]
stc_df$sample_id <- gsub("STC", "STC_", stc_df$sample_id, fixed=TRUE)
stc_df$sample_id <- sub("(.*)_[^_]*$", "\\1", stc_df$sample_id)
arsrl_result_df <- rbind(arsrl_result_df,stc_df)
}
#Check if QC_BBR sample is present in the id list
bbr_sample <- grep("QC_BBR", wgs_df[['sample_id']], value = TRUE)
bbr_sample_count <- length(bbr_sample)
#manually add result for QC_BBR
if(bbr_sample_count !=0){
sample_id = sub("(.*)_[^_]*$", "\\1", bbr_sample)
arsrl_org = "Bordetella bronchiseptica"
arsrl_result_df <- arsrl_result_df %>%
add_row(sample_id = sample_id, arsrl_org=arsrl_org)
}
#Check if QC_BBR sample is present in the id list
vc_sample <- grep("VC", wgs_df[['sample_id']], value = TRUE)
vc_sample_count <- length(vc_sample)
#manually add result for QC_BBR
if(vc_sample_count !=0){
sample_id = sub("(.*)_[^_]*$", "\\1", vc_sample)
arsrl_org = "Neisseria gonorrhoeae"
arsrl_result_df <- arsrl_result_df %>%
add_row(sample_id = sample_id, arsrl_org=arsrl_org)
}
# Referred isolates with WGS result, but the referred data have not been endorsed for encoding to DMU
no_referred_data <- setdiff(arsrl_result_df$sample_id, sample_name_clean)
arsrl_id <- arsrl_result_df$sample_id
no_referred_data <- setdiff(arsrl_id, sample_name_clean)
View(arsrl_result_df)
wgs_df1 <- wgs_df
#wgs_df <- wgs_df1
arsrl_result_df1 <- arsrl_result_df
#arsrl_result_df <- arsrl_result_df1
if(nrow(wgs_df) != 0){
rmarkdown::render("wgs_qc_report.Rmd",
output_file = paste("ARSRL_WGS_QC_report_",batch_code, '.pdf', sep='')
)
}else{
cat("No file found")
}
View(reco_df)
gc()
